var onLineTrafficViewTemplate='<div class="page onLineTrafficPage"><div id="form"><p class="header">Слідкуй</p><input class="busInput" type="checkbox" id="1"><input class="busInput" type="checkbox" id="2"><input class="busInput" type="checkbox" id="3"><input class="busInput" type="checkbox" id="4"><input class="busInput" type="checkbox" id="5"><input class="busInput" type="checkbox" id="6"><input class="busInput" type="checkbox" id="7"></div><div id="polylines"><div id="sp"><p class="header">Клікни</p><span class="routeSpan">1H</span><span class="routeSpan">2H</span><span class="routeSpan">3H</span><span class="routeSpan">4H</span><span class="routeSpan">5H</span><span class="routeSpan">6H</span><span class="routeSpan">7H</span><br></div><div id="pi"><p class="header">Дивись</p><input class="polylineInput" id="1H" type="checkbox"><input class="polylineInput" id="2H" type="checkbox"><input class="polylineInput" id="3H" type="checkbox"><input class="polylineInput" id="4H" type="checkbox"><input class="polylineInput" id="5H" type="checkbox"><input class="polylineInput" id="6H" type="checkbox"><input class="polylineInput" id="7H" type="checkbox"><br></div></div><div id="ftr">Як часто показувати автобуси ?<select id="interval" name="interval"><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option><option value="60">60</option></select>',busInfoTemplate='<div id="#busInfo"><span id="closeInfo">X</span><p><%= obj.route%></p><p><%= obj.way %></p><p>Ціна: <%= obj.price %></p><p>Інтервал руху: <%= obj.interval %></p><p>Час: <%= obj.time %></p><p>Прямий маршрут: <%= obj.sw %></p><p>Зворотній маршрут: <%= obj.bw %></p></div>',mainTemplate='<div class="page chatPage"><div id="formChat"></div><ul id="body"></ul></div>',formTemplate='<div id="username"><div id="img"><label><img src="https://cdn0.iconfinder.com/data/icons/user-pictures/100/male-48.png"><input type="radio" name="user" checked></label><label><img src="https://cdn0.iconfinder.com/data/icons/user-pictures/100/boy-2-48.png"><input type="radio" name="user"></label><label><img src="https://cdn0.iconfinder.com/data/icons/user-pictures/100/female-48.png"><input type="radio" name="user" ></label><label><img src="https://cdn0.iconfinder.com/data/icons/user-pictures/100/matureman1-2-48.png"><input type="radio" name="user" ></label><label><img src="https://cdn0.iconfinder.com/data/icons/user-pictures/100/girl-2-48.png"><input type="radio" name="user"></label></div><input id="name" type="text" placeholder="Введіть свій нікнейм"><input type="button" value="ок" id="okey" class="btn"></div><div id="commentbox"><textarea id="comment" maxlength="100"></textarea><input type="button" value="ok" id="ok" class="btn"></div>',commentTemplate='<div id="chat"><% comments.forEach(function(mod) { %><div class="msg"><div class="leftcont"><div><img src ="<%= mod.icon %>"/></div><div><%= mod.name %></div></div><div class = "rightcont"><div><%= mod.comments %></div><div class="time"><%= mod.time %></div></div></div><% }) %><input type="button", value="попередні", id="show" class="btn"></div>',searchcViewTemplate='<div class="page searchPage"><div class="autocomplete"><p>ПОШУК</p><div class="right"><label for="from">від</label><input type="text" id="from" name="from" /></div><div class="right"><label for="to">до</label><input type="text" id="to" name="to" /></div><div class="right center"><input type="button" id="clear" name="clear" class="btn btn-default" value="очистити" /><input type="button" id="search" name="search" class="btn btn-default" value="знайти"  /></div></div><div class="find"><div class="infoContainer">Ви можете натиcнути &lsquo;старт&rsquo; і зробити два кліки: перший &mdash; точка відправлення, другий &mdash; призначення. Натиснувши &lsquo;я тут&rsquo;, точка відправлення автоматично стане відповідати вашому місцезнаходженню (якщо ви дали відповідний дозвіл при завантаженні сторінки). Для видалення міток на карті натисніть &lsquo;видалити&rsquo;.</div></div><div class="buttons"><input type="button" id="start" name="start" class="btn btn-default" value="старт"><input type="button" id="here" name="here" class="btn btn-default" value="я тут"><input type="button" id="delete" name="delete" class="btn btn-default" value="видалити"></div><div class="info"></div></div>',OnLineTrafficView=Backbone.View.extend({initialize:function(){this.timerArray={},this.markersArray={},this.stoper={},this.busArray={},this.anglesArray={},this.render(),this.response=[],this.setResponse()},render:function(){var e=_.template(onLineTrafficViewTemplate);$(".submenu").append(e)},el:".submenu",events:{"change #form input:checkbox":"listener","click #polylines input:checkbox":"passPoliline","click #polylines span":"showPopup","click #closeInfo":"hidePopup"},getPosition:function(){menuView.getYourPosition()},getBusArray:function(e){return this.busArray["id"+e]},setBusArray:function(e,t){this.busArray["id"+e]=t},getAnglesArray:function(e){return this.anglesArray["id"+e]},setAnglesArray:function(e,t){this.anglesArray["id"+e]=t},setStoper:function(e,t){this.stoper["id"+e]=t},getStoper:function(e){return this.stoper["id"+e]},setTimer:function(e,t){this.timerArray["id"+e]=t},getTimer:function(e){return this.timerArray["id"+e]},setMarkers:function(e,t){this.markersArray["id"+e]=t},pushMarkers:function(e,t){this.markersArray["id"+e].push(t)},getMarkers:function(e){return this.markersArray["id"+e]},getAngle:function(e,t){var i=t.G-e.G,n=t.K-e.K,s=180*Math.atan2(i,n)/Math.PI;return 0>i&&(s+=360),90-s},listener:function(e){var t=$("#interval").val()||3,i=$(e.currentTarget),n=i.attr("id");if(i.is(":checked"))this.setStoper(n,!0),this.firstRequest(n),this.busOnWay(n,t);else{this.setStoper(n,!1),clearInterval(this.getTimer(n));var s=menuView.getMap();this.setMarker([],s,n,!1)}},firstRequest:function(e){var t=this,i=(menuView.getMap(),"https://nightbus.localtunnel.me/api/routes?route="+e+"H");t.setMarkers(e,[]),t.fetch(i,t.getFirstCoordinates,e)},getFirstCoordinates:function(e,t,i){if(i.getStoper(t)){for(var n=menuView.getMap(),s=[],o=0;o<e.length;o++)s.push(new google.maps.LatLng(e[o].lat,e[o].lng));i.setBusArray(t,s),i.setAnglesArray(t,[]),i.setMarker(s,n,t,0,!0)}},fetch:function(e,t,i){var n=this;$.ajax({type:"GET",dataType:"json",url:e,success:function(e){t(e,i,n)},error:function(e){console.log(e)}})},busOnWay:function(e,t){var i=this;i.setMarkers(e,[]);var n=1e3*t,s="https://nightbus.localtunnel.me/api/routes?route="+e+"H",o=setInterval(function(){i.fetch(s,i.getCoordinatesAndAngles,e)},n);i.setTimer(e,o)},getCoordinatesAndAngles:function(e,t,i){var n,s,o,a=[],r=[],l=[],c=[],u=menuView.getMap();if(i.getStoper(t)){for(var p=0;p<e.length;p++)c.push(new google.maps.LatLng(e[p].lat,e[p].lng));r=i.getBusArray(t),l=i.getAnglesArray(t),i.setBusArray(t,c);for(var p=0;p<c.length;p++)o=i.getAngle(r[p],c[p]),n=c[p],s=r[p],n.G===s.G&&n.K===s.K&&(o=l[p]),a.push(o);i.setAnglesArray(t,a),i.setMarker(c,u,t,a,!0)}},setMarker:function(e,t,i,n,s){function o(e,n){var s,o,a,r,l;switch(i){case"1":s="#0000FF";break;case"2":s="#7FFF00";break;case"3":s="#FFA500";break;case"4":s="#FF0000";break;case"5":s="#00FFFF";break;case"6":s="#FFFF00";break;case"7":s="#FF00FF";break;default:s="#000000"}o={path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,fillColor:s,fillOpacity:.9,scale:4,rotation:n,strokeWeight:1},a=new google.maps.Marker({position:e,title:i+"H",map:t,icon:o}),r={content:i+"H"},l=new google.maps.InfoWindow(r),a.addListener("click",function(){l.open(t,a),setTimeout(function(){l.close()},1e3)}),c.pushMarkers(i,a)}function a(e){for(var t=c.getMarkers(i),n=0;n<t.length;n++)t[n].setMap(e);null===e&&c.setMarkers(i,[])}function r(){a(null)}function l(){r()}{var c=this;c.getMarkers(i)}if(l(),s){c.setMarkers(i,[]);for(var u=0;u<e.length;u++)o(e[u],n[u]),a(t)}},setResponse:function(){var e=this;$.ajax({type:"GET",async:!0,dataType:"json",url:"https://nightbus.localtunnel.me/api/routes/",success:function(t){e.putResponse(t)},error:function(e){console.log(e)}})},putResponse:function(e){this.response=e,menuView.setCount()},getResponse:function(){return this.response},getPoli:function(e){this.poliarr=menuView.getPoliArray();var t=[];switch(e){case"1H":t=this.getCoords("1H"),this.poliarr[e].setOptions({strokeColor:"#00FFFF",path:t});break;case"2H":t=this.getCoords("2H"),this.poliarr[e].setOptions({strokeColor:"#FF0000",path:t});break;case"3H":t=this.getCoords("3H"),this.poliarr[e].setOptions({strokeColor:"#FFFF00",path:t});break;case"4H":t=this.getCoords("4H"),this.poliarr[e].setOptions({strokeColor:"#FF5722",path:t});break;case"5H":t=this.getCoords("5H"),this.poliarr[e].setOptions({strokeColor:"#FFC107",path:t});break;case"6H":t=this.getCoords("6H"),this.poliarr[e].setOptions({strokeColor:"#C2185B",path:t});break;case"7H":t=this.getCoords("7H"),this.poliarr[e].setOptions({strokeColor:"#4CAF50",path:t})}},getCoords:function(e){var t=[],i=this.getResponse();return i.forEach(function(i){i.name==e&&(t=i.routeArray)}),t.map(function(e){return new google.maps.LatLng(e.lat,e.lng)})},drawPoliline:function(e){var t=menuView.getMap(),i=this;$.when(i.getPoli(e)).then(function(){i.poliarr[e].setMap(t)})},hidePoliline:function(e){var t=(menuView.getMap(),this);$.when(t.getPoli(e)).then(function(){t.poliarr[e].setMap(null)})},passPoliline:function(e){{var t=$(e.currentTarget);menuView.getMap()}waynumber=t.attr("id"),t.is(":checked")?this.drawPoliline(waynumber):this.hidePoliline(waynumber)},showPopup:function(e){var t=this.setInfo(),i=$(e.currentTarget).text();for(var n in t)n==i&&(information=t[n]);var s=_.template(busInfoTemplate);$("#busInfo").html(s({obj:information})),$("#busInfo").show()},setInfo:function(){var e={};return this.response.forEach(function(t){e[t.name]={route:t.info.route,way:t.info.way,price:t.info.price,interval:t.info.interval,time:t.info.time,sw:t.info.sw,bw:t.info.bw}}),e},getInfo:function(){return this.info},hidePopup:function(){$("#busInfo").hide()}}),SearchView=Backbone.View.extend({el:$(".submenu"),events:{"click #start":"getPoints","click #search":"setPoints","click #clear":"clear","click #here":"getPosition","click #delete":"clearMap"},template:_.template(searchcViewTemplate),busStopArray:[],busStopMarkers:[],listener:null,initialize:function(){var e=this;this.fetch("https://nightbus.localtunnel.me/api/routes",e.setBusStopArray),this.$el.append(this.template),this.autocompleteListener(),this.poliline=[],this.markers=[],this.circles=[],this.infowindow=[],this.from=null,this.to=null},fetch:function(e,t){var i=this;$.ajax({type:"GET",dataType:"json",url:e,success:function(e){t(e,i)},error:function(e){console.log("request error")}})},clear:function(){this.$el.find(from).val(""),this.$el.find(to).val("")},getPosition:function(){var e=menuView.getYourPosition();return $.isEmptyObject(e)?void alert("Немає даних із геолокації."):void(menuView.isInLviv(e)&&this.getPoints(null,1,e))},busStopCoordinateComparison:function(e,t,i){for(var n=0,s=i.length;s>n;n++){var o=i[n];if(t.busStop==o.busStop&&t.lat==o.lat&&t.lng==o.lng)return-1==o.route.indexOf(e.name)&&i[n].route.push(e.name),i;n==s-1&&(i.push(t),i[n+1].route=[e.name])}return 0===s&&(i.push(t),i[0].route=[e.name]),i},setBusStopArray:function(e,t){var i=[];e.forEach(function(e){e.routeArray.forEach(function(n){n.busStop&&(i=t.busStopCoordinateComparison(e,n,i))})}),t.busStopArray=i,menuView.setCount()},getBusStopArray:function(){return this.busStopArray},autocomplete_map:function(e){var t=this,i=new google.maps.places.Autocomplete(e);google.maps.event.addListener(i,"place_changed",function(){t["field"+e.name]=i.getPlace().geometry.location})},autocompleteListener:function(){var e=$("#from"),t=$("#to");this.autocomplete_map(e[0]),this.autocomplete_map(t[0])},setBusStopMarkers:function(){var e=this,t=menuView.getMap();busStopArray=this.getBusStopArray(),busStopArray.forEach(function(i){e.busStopMarkers.push(new google.maps.Marker({position:i,map:t,visible:!1}))})},getBusStopMarkers:function(){return this.busStopMarkers},setMarkers:function(e){var t=this,i=menuView.getMap();t.markers.push(new google.maps.Marker({position:e,map:i,visible:!0,icon:"img/unisex.png"}))},deleteMarkers:function(e){return e.forEach(function(e){e.setMap(null)}),e=[]},clearMap:function(){this.$el.find(".info").html(""),this.markers=this.deleteMarkers(this.markers),this.infowindow.forEach(function(e){e.close()}),this.poliline&&this.poliline.forEach(function(e){menuView.onLineTraffic.hidePoliline(e)}),this.$el.find(".info").css({display:"none"})},setInfowindow:function(e){var t=this,i=menuView.getMap();e.forEach(function(e){myOptions={map:i,position:{lng:e.lng,lat:e.lat},content:e.busStop},t.infowindow.push(new google.maps.InfoWindow(myOptions))})},getNearestBusStops:function(e){var t,i,n=[],s=[],o=1e4,a=(menuView.getMap(),this.getBusStopArray());return this.setMarkers(e),this.getBusStopMarkers().forEach(function(i,s){t=google.maps.geometry.spherical.computeDistanceBetween(i.getPosition(),e),o>t&&(o=t),n.push(t)}),i=o+150,n.forEach(function(e,t){i>e&&s.push(a[t])}),this.setInfowindow(s),s},getBusNumbers:function(e,t){var i,n=[],s="маршрутом ",o=[],a=[];if(e.forEach(function(e){e.route.forEach(function(e){-1==o.indexOf(e)&&o.push(e)}),t.forEach(function(t){t.route.forEach(function(t){-1!=e.route.indexOf(t)?-1==n.indexOf(t)&&n.push(t):-1==a.indexOf(t)&&a.push(t)})})}),0===n.length&&0!==o.length)i=n.join(", "),this.$el.find(".info").css({display:"block"}).html("На жаль, прямого маршруту немає. Спочатку вам потрібно сісти на "+o.join(" або ")+", а потім пересісти на "+a.join(" або ")+"."),n=o.concat(a);else{if(!(n.length>=1))return void this.$el.find(".info").css({display:"block"}).html("Відсутнє з&rsquo;єднання із сервером.");i=n.join(", "),n.length>1&&(s="наступними маршрутами: "),this.$el.find(".info").css({display:"block"}).html("Ви можете доїхати з точки відправлення до точки призначення "+s+i+".")}n.forEach(function(e){menuView.onLineTraffic.drawPoliline(e)}),this.poliline=this.poliline.concat(n),google.maps.geometry.spherical.computeDistanceBetween(this.from,this.to)<500&&this.$el.find(".info").append(" До речі, до вашої цілі менше 500 м.")},clickListener:function(e,t,i){var n=this;this.listener=google.maps.event.addListener(i,"click",function(s){menuView.isInLviv(s.latLng)?(0===e?n.from=s.latLng:n.to=s.latLng,e++,t.push(n.getNearestBusStops(s.latLng)),2==e&&(google.maps.event.removeListener(n.listener),n.busStopMarkers=n.deleteMarkers(n.busStopMarkers),n.getBusNumbers(t[0],t[1]),i.setOptions({disableDoubleClickZoom:!1}),n.$el.parent().find(".search").removeClass("dblclicked"),n.$el.parent().find(".search").addClass("newInfo"))):alert("Вказане місце поза Львовом. Виберіть інше місце!")})},getPoints:function(e,t,i){this.$el.parent().find(".search").addClass("dblclicked");var n=this,s=t||0,o=[],a=menuView.getMap();this.setBusStopMarkers(),a.setOptions({disableDoubleClickZoom:!0}),menuView.hidePage(),t&&(this.fieldfrom=i,o.push(n.getNearestBusStops(i))),this.clickListener(s,o,a)},setPoints:function(){if(this.fieldfrom&&menuView.isInLviv(this.fieldfrom))if(this.fieldto&&menuView.isInLviv(this.fieldto)){this.from=this.fieldfrom,this.to=this.fieldto,menuView.hidePage(),this.setBusStopMarkers();var e=this.getNearestBusStops(this.fieldfrom),t=this.getNearestBusStops(this.fieldto);this.busStopMarkers=this.deleteMarkers(this.busStopMarkers),this.getBusNumbers(e,t),this.$el.parent().find(".search").addClass("newInfo")}else alert("Перевірте місце призначення. Можливо, адреса вказана невірно, або знаходиться за межами досяжності наших маршрутів.");else alert("Перевірте місце відправлення. Можливо, адреса вказана невірно, або знаходиться за межами досяжності наших маршрутів.")}}),ChatView=Backbone.View.extend({initialize:function(){this.render(),this.form=new FormView,this.app=new CommentsView},setIntAjax:function(){var e=this;this.interval=setInterval(function(){e.app.render()},5e3)},render:function(){var e=_.template(mainTemplate);$(".submenu").append(e)},getUser:function(){return this.user},closeInterval:function(){clearInterval(this.interval)}});CommentModel=Backbone.Model.extend({toJSON:function(){return _.extend(this.attributes,{time:new Date(this.attributes.time).toLocaleString()})}}),CommentCollection=Backbone.Collection.extend({model:CommentModel});var collection=new CommentCollection,CommentView=Backbone.View.extend({el:"#body",render:function(){return $.ajax({url:"https://nightbus.localtunnel.me/api/comments?name="+this.model.get("name")+"&time="+this.model.get("time")+"&comment="+this.model.get("comments")+"&icon="+this.model.get("icon"),type:"POST",dataType:"json",crossDomain:!0,success:function(e){}}),this},initialize:function(){this.render()}}),CommentsView=Backbone.View.extend({el:"#body",initialize:function(){collection.on("add",this.render,this),this.prev=0,this.render(),this.counter=this.templ=1,this.array=[]},template:_.template(commentTemplate),render:function(){that=this,$.ajax({type:"GET",dataType:"json",async:!0,url:"https://nightbus.localtunnel.me/api/comments/",success:function(e){var t=[];e.forEach(function(e){t.push(e)}),t.reverse(),that.array=t.slice(0,10*that.counter),collection.reset(that.array),(e.length!=that.prev||that.templ!=that.counter)&&$(that.el).html(that.template({comments:collection.toJSON()})),t.length<=10*that.counter&&$(that.el).find("input").hide(),that.prev=e.length,that.templ=that.counter}})},events:{"click #show":"showAll"},showAll:function(){this.counter++,this.render()}}),FormView=Backbone.View.extend({el:"#formChat",template:_.template(formTemplate),render:function(){return this.$el.append(this.template),this},initialize:function(){this.username="",this.icon="",this.render()},events:{"click #ok":"addContact","click #okey":"saveData"},addContact:function(){var e=new CommentModel,t=this.$el.find("textarea");if($(t).val().match(/[a-zA-Zа-яА-Яії]{3,100}/gi)){e.set({name:this.username,comments:$(t).val(),time:(new Date).getTime(),icon:this.icon});{new CommentView({model:e})}collection.add(e),$("#comment").val("")}},saveData:function(){if(this.username=$("#name").val(),this.username.match(/[a-zA-Zа-яА-Яії]{3,30}/gi)){for(var e=$("#img").find("input"),t=0,i=e.length;i>t;t++)if(e[t].checked){var n=$($(e[t]).closest("label")).find("img");this.icon=n.attr("src")}$("#commentbox").show(),$("#username").hide()}}}),MenuView=Backbone.View.extend({el:$("#nav"),events:{"click .search":"renderSearch","click .chat":"renderChat","click .onLineTraffic":"renderOnLineTraffic"},searchView:null,chatView:null,onLineTraffic:null,initialize:function(){this.yourPosition={},this.count=0,this.mapInitialize()},mapInitialize:function(){var e=[{featureType:"transit.station",elementType:"labels.icon",stylers:[{visibility:"off"}]}],t={zoom:13,styles:e,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.RIGHT_CENTER},streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},scaleControl:!0,mapTypeId:google.maps.MapTypeId.ROADMAP},i={strokeOpacity:.7,strokeWeight:5};this.poliArray={"1H":new google.maps.Polyline(i),"2H":new google.maps.Polyline(i),"3H":new google.maps.Polyline(i),"4H":new google.maps.Polyline(i),"5H":new google.maps.Polyline(i),"6H":new google.maps.Polyline(i),"7H":new google.maps.Polyline(i)},this.map=new google.maps.Map(document.getElementById("map"),t),this.getGeoLocation(),this.createInstance()},createInstance:function(){this.searchView=new SearchView,this.onLineTraffic=new OnLineTrafficView},createBusStopView:function(){new BusStopView},isInLviv:function(e){var t,i=this.map,n={lat:49.827145,lng:24.026072},s={map:i,center:n,radius:9e3,visible:!1},o=new google.maps.Circle(s),a=new google.maps.Marker({position:e,map:i,visible:!1});return t=o.getBounds().contains(a.getPosition()),a.setMap(null),a=null,t},setCount:function(){this.count++,2==this.count&&menuView.createBusStopView()},getMap:function(){return this.map},getPoliArray:function(){return this.poliArray},getGeoLocation:function(){var e=this.getMap(),t=this;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(i){{var n=new google.maps.LatLng(i.coords.latitude,i.coords.longitude);({lat:n.G,lng:n.K})}t.isInLviv(n)||(n=new google.maps.LatLng(49.83916569,23.99448127));new google.maps.InfoWindow({map:e,position:n,content:"Я тут"});t.setYourPosition(n),e.setCenter(n)},function(){t.handleNoGeolocation(!0)}):t.handleNoGeolocation(!1)},handleNoGeolocation:function(e){if(e)var t="";else var t="Error: Your browser doesn't support geolocation.";var i={map:this.map,position:new google.maps.LatLng(49.83916569,23.99448127),content:t};this.map.setCenter(i.position)},setYourPosition:function(e){this.yourPosition=e},getYourPosition:function(){return this.yourPosition},renderSearch:function(){this.$el.find(".search").hasClass("clicked")?this.hidePage():this.render(".search")},renderChat:function(){this.chatView||(this.chatView=new ChatView),this.$el.find(".chat").hasClass("clicked")?this.hidePage():this.render(".chat")},renderOnLineTraffic:function(){this.$el.find(".onLineTraffic").hasClass("clicked")?this.hidePage():this.render(".onLineTraffic")},hidePage:function(){var e=this,t=0;return submenu=e.$el.parent().find(".submenu"),submenu.find(".page").css({display:"none"}),this.$el.find(".chat").hasClass("clicked")&&this.chatView.closeInterval(),submenu.hasClass("active")&&(submenu.removeClass("active"),t=1e3),e.$el.find(".clicked").removeClass("clicked"),t},render:function(e){var t=this.$el.parent().find(".submenu"),i=this.hidePage();".chat"==e&&this.chatView.setIntAjax(),".search"==e&&this.searchView.listener&&(google.maps.event.removeListener(this.searchView.listener),this.map.setOptions({disableDoubleClickZoom:!1}),this.$el.find(".search").hasClass("dblclicked")&&(this.searchView.busStopMarkers=this.searchView.deleteMarkers(this.searchView.busStopMarkers),this.$el.find(".search").removeClass("dblclicked"))),this.$el.find(e).removeClass("newInfo").addClass("clicked"),setTimeout(function(){t.addClass("active")},i),setTimeout(function(){t.hasClass("active")&&t.find(e+"Page").css({display:"block"})},i+1e3)}}),menuView=new MenuView,BusStopView=Backbone.View.extend({initialize:function(){var e=this;e.response=menuView.onLineTraffic.getResponse(),this.map=menuView.getMap(),this.stop=menuView.searchView.getBusStopArray(),this.markers=[],this.greateMarkerArray(),this.timeForMarkers(),this.contentString},greateMarkerArray:function(){var e=this,t=new google.maps.MarkerImage("http://icons.iconarchive.com/icons/danieledesantis/playstation-flat/32/playstation-circle-icon.png",null,null,null,new google.maps.Size(15,15));this.stop.forEach(function(i){{var n=new google.maps.Marker({position:new google.maps.LatLng(i.lat,i.lng),icon:t,visibility:!1,title:i.busStop+"|"+i.route});i.route.map(function(e){return e})}e.markers.push(n)}),google.maps.event.addListener(this.map,"zoom_changed",function(){var t=e.map.getZoom();e.markers.forEach(function(i){i.setMap(e.map),i.setVisible(t>=15)})})},timeForMarkers:function(){var e=this,t=new google.maps.InfoWindow;this.markers.forEach(function(i){google.maps.event.addListener(i,"click",function(){var n=i.getTitle(),s=n.split("|"),o=s[0],a=s[1],r=a.split(","),l=i.getPosition();e.contentString="<h4>"+o+"</h4>",e.checkBusName(r,e.contentString,l),t.setContent(e.contentString),t.open(e.map,i)})})},formatTime:function(e){var t="";if(60>e)t=e+" сек";else if(e>60&&e%60==0)t=e/60+" хв";else if(e>60&&e%60!=0){var i=Math.floor(e/60),n=e-60*i;t=i+"хв. "+n+"сек"}return t},checkBusName:function(e,t,i){that=this,e.forEach(function(e){if($("#"+e[0]+":checked").val()){var t=[];that.response.forEach(function(i){i.name==e&&(t=i.routeArray)});var n,s=that.getIndexOfBusStop(i,t),o=menuView.onLineTraffic.getBusArray(e[0]),a=that.getBusesIndex(o,t),r=that.checkBusIndex(a,s),l=that.getMaxOfArray(r);s>l?n=10*(s-l-1):l>s&&(n=10*(t.length-1-(l-s-1))),n=that.formatTime(n),that.contentString+="<p>"+e+" : "+n+"</p>"}else that.contentString+="<p>"+e+" - </p>"})},checkBusIndex:function(e,t){var i=e.filter(function(e){return t>e});return 0==i.length&&(i=e.filter(function(e){return e>t})),i},getMaxOfArray:function(e){return Math.max.apply(null,e)},getIndexOfBusStop:function(e,t){var i,n=[];return t.forEach(function(t,i){t.lat==e.G.toFixed(8)&&t.lng==e.K.toFixed(8)&&n.push(i)}),i=n[1]},getBusesIndex:function(e,t){var i=[];return e.forEach(function(e){t.forEach(function(t,n){t.lat==e.G.toFixed(8)&&t.lng==e.K.toFixed(8)&&i.push(n)})}),i}});